<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>我的购物清单（Worker 安全版）</title>
  <style>
    body {
      font-family: "Segoe UI", "PingFang SC", Arial, sans-serif;
      background: #f7f8fa;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
    }
    h1 { text-align: center; margin-bottom: 1rem; }
    form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; background: #f1f3f6; padding: 1rem; border-radius: 8px; }
    label { flex: 1 1 45%; }
    input, button { width: 100%; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; }
    button { background: #3182ce; color: white; border: none; cursor: pointer; }
    ul { list-style: none; padding: 0; }
    li { background: #fff; margin-bottom: 0.75rem; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    li.bought { background: #e2e8f0; }
    .item-info del { color: #888; }
    .item-actions button { margin-left: 0.5rem; background: #edf2f7; color: #444; }
    .item-actions button:last-child { background: #fee2e2; color: #b91c1c; }
    .totals { margin-top: 2rem; padding: 1rem; background: #f0f4f8; border-radius: 8px; text-align: center; }
    .warn { color: #c53030; text-align: center; margin-bottom: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <div class="warn"></div>
  <h1>🛒 我的购物清单</h1>
  <form id="addForm">
    <label>商品名称<input type="text" id="name" required></label>
    <label>商品价格<input type="number" id="price" min="0" step="0.01" required></label>
    <label style="flex: 1 1 100%;">商品链接<input type="url" id="link" placeholder="https://"></label>
    <button type="submit">添加商品</button>
  </form>

  <ul id="itemList"></ul>

  <div class="totals">
    ✅ 已购买总价：<span id="boughtTotal">0.00</span> 元<br>
    🛒 未购买总价：<span id="unboughtTotal">0.00</span> 元
  </div>

  <script>
    const apiUrl = 'https://workertest.lcandfq.workers.dev/'; // 👈 替换成你的 Worker URL
    let items = [];

    async function loadItems() {
      try {
        const res = await fetch(apiUrl);
        items = await res.json();
        render();
      } catch (e) {
        console.error('加载失败', e);
        items = [];
        render();
      }
    }

    async function saveItems() {
      try {
        await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(items)
        });
      } catch (e) {
        console.error('保存失败', e);
      }
    }

    function render() {
      const list = document.getElementById('itemList');
      list.innerHTML = '';
      let boughtSum = 0, unboughtSum = 0;
      items.forEach((item, i) => {
        const li = document.createElement('li');
        li.className = item.bought ? 'bought' : '';
        const info = document.createElement('div');
        info.className = 'item-info';
        info.innerHTML = item.bought
          ? `<del>${item.name}</del> <del>${item.price.toFixed(2)}元</del> ${item.link ? `<del><a href="${item.link}" target="_blank">链接</a></del>` : ''}`
          : `${item.name} ${item.price.toFixed(2)}元 ${item.link ? `<a href="${item.link}" target="_blank">链接</a>` : ''}`;

        if (item.bought) boughtSum += item.price;
        else unboughtSum += item.price;

        const actions = document.createElement('div');
        actions.className = 'item-actions';
        actions.innerHTML = `
          <button onclick="toggle(${i})">${item.bought ? '未购买' : '已购买'}</button>
          <button onclick="del(${i})">删除</button>
        `;
        li.appendChild(info);
        li.appendChild(actions);
        list.appendChild(li);
      });
      document.getElementById('boughtTotal').textContent = boughtSum.toFixed(2);
      document.getElementById('unboughtTotal').textContent = unboughtSum.toFixed(2);
    }

    window.toggle = async function(i) {
      items[i].bought = !items[i].bought;
      await saveItems();
      render();
    };

    window.del = async function(i) {
      items.splice(i, 1);
      await saveItems();
      render();
    };

    document.getElementById('addForm').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const link = document.getElementById('link').value.trim();
      if (!name || isNaN(price)) return;
      items.push({ name, price, link, bought: false });
      await saveItems();
      render();
      this.reset();
    };

    loadItems();
  </script>
</body>
</html>
